<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>R‑arvo‑pinoaja v4 – lämpötase + auto‑täyttö + poista viimeisin</title>
  <style>
    :root{--bg:#0b0d10;--card:#12161b;--ink:#e9edf1;--muted:#9fb0c0;--accent:#4fd1c5;--bad:#ff6b6b;--ok:#a7f3d0}
    *{box-sizing:border-box}body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;background:var(--bg);color:var(--ink)}
    header{padding:14px 18px;border-bottom:1px solid #1f2937;background:#0b0d10;position:sticky;top:0}
    h1{font-size:18px;margin:0}
    main{padding:18px;max-width:1100px;margin:0 auto;display:grid;grid-template-columns:1.05fr .95fr;gap:16px}
    @media (max-width:960px){main{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:14px;padding:14px}
    .section-title{font-size:13px;text-transform:uppercase;color:var(--muted);letter-spacing:.12em;margin:8px 0}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
    input,select{width:100%;background:#0e1217;color:var(--ink);border:1px solid #293241;border-radius:10px;padding:9px 10px;font-size:14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{background:var(--accent);color:#0b0d10;border:none;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
    .btn.secondary{background:#243141;color:var(--ink);border:1px solid #334155}
    .muted{color:var(--muted);font-size:12px}
    .pill{display:inline-block;background:#0f172a;border:1px solid #233147;padding:6px 10px;border-radius:999px;margin:4px 6px 0 0;font-size:13px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #1f2a3c;padding:8px 6px;text-align:left;font-size:14px}
    th{color:var(--muted);font-weight:600}
    .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
    .kpi>div{background:#0f1320;border:1px solid #1f2a3c;border-radius:12px;padding:12px}
    .kpi .label{color:var(--muted);font-size:12px}
    .kpi .value{font-size:18px;font-weight:800}
    .ok{color:var(--ok);font-weight:800}
    .bad{color:var(--bad);font-weight:800}
    .del{background:#1f2937;border:1px solid #2b3b52;color:#cbd5e1;padding:4px 8px;border-radius:8px;cursor:pointer}
    .err{color:var(--bad);font-size:12px;margin-top:6px;display:none}
  </style>
</head>
<body>
  <header><h1>R‑arvo‑pinoaja v4 – lämpötase + auto‑täyttö + poista viimeisin</h1></header>
  <main>
    <section class="card">
      <div class="section-title">1) Lisää alustoja pinoon</div>
      <div class="grid">
        <div>
          <label>Valitse tyyppi</label>
          <select id="presetSelect">
            <option value="">— Valitse —</option>
            <option value="air2">Ilmapatja kevyt (R≈2.0, ~400 g)</option>
            <option value="air35">Ilmapatja 3‑kerros (R≈3.5, ~500 g)</option>
            <option value="air55">Talvi‑ilmapatja (R≈5.5, ~700 g)</option>
            <option value="foam1">Solumuovi ohut (R≈1.0, ~200 g)</option>
            <option value="foam2">Solumuovi paksu (R≈2.0, ~400 g)</option>
          </select>
        </div>
        <div><label>R (jos mukautat)</label><input id="presetR" type="text" placeholder="esim. 2,0 tai 2.0"></div>
        <div><label>Paino (g, valinn.)</label><input id="presetW" type="text" placeholder="esim. 400"></div>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="addPreset">Lisää pinoon</button>
        <button class="btn secondary" id="removeLast">Poista viimeisin lisätty</button>
        <button class="btn secondary" id="clearList">Tyhjennä pino</button>
      </div>
      <div id="err" class="err"></div>

      <div class="section-title" style="margin-top:10px">Pino</div>
      <table id="stackTable"><thead><tr><th>Nimi</th><th>R</th><th>Paino (g)</th><th></th></tr></thead><tbody></tbody></table>

      <div class="section-title" style="margin-top:12px">2) Yöolosuhteet</div>
      <div class="grid">
        <div><label>Yölämpötila (°C)</label><input id="tempNight" type="text" placeholder="esim. 0"></div>
        <div><label>Oletko vilukissa vai lämmin nukkuja?</label>
          <select id="sleeper"><option value="cold">Vilukissa</option><option value="normal" selected>Normaali</option><option value="warm">Lämmin</option></select>
        </div>
        <div><label>Maapinta</label>
          <select id="ground"><option value="mineral" selected>Kivikko/maa</option><option value="duff">Humus/sammal</option><option value="snow">Tiivis lumi</option></select>
        </div>
        <div><label>Lisäsuoja lattian alla</label>
          <select id="floor"><option value="none" selected>Ei</option><option value="sheet">Ohut lattiasuoja/maavaate</option></select>
        </div>
        <div><label>Makuupussin T‑comfort (°C) <span class="muted">(valinn.)</span></label><input id="bagComfort" type="text" placeholder="esim. -2"></div>
      </div>

      <div style="margin-top:10px" class="row">
        <button class="btn" id="calc">Laske</button>
        <button class="btn secondary" id="autoFill">Täytä vaadittu R (paino‑optimoitu)</button>
        <button class="btn secondary" id="preset1">Preset: Kesä (R~2.0)</button>
        <button class="btn secondary" id="preset2">Preset: Syksy (R~3.5 + foam)</button>
        <button class="btn secondary" id="preset3">Preset: Talvi (R~7.0)</button>
      </div>
      <div class="muted" style="margin-top:6px">R_req = 0.8 + 0.12 × (20 − T_yö) ± nukkuja, − maapinnan/lattiasuojan bonus. Auto‑täyttö valitsee <strong>kevyimmän</strong> tavan täyttää vaadittu R (yleensä solumuovi).</div>
    </section>

    <section class="card">
      <div class="section-title">Tulos</div>
      <div class="kpi">
        <div><div class="label">R‑yhteensä (pino)</div><div class="value" id="rtot">–</div></div>
        <div><div class="label">Vaadittu R (padille)</div><div class="value" id="rneed">–</div></div>
        <div><div class="label">Erotus (pino − vaad.)</div><div class="value" id="rgap">–</div></div>
      </div>
      <div class="kpi">
        <div><div class="label">Arvioitu alin lattialämpö</div><div class="value" id="tfloor">–</div></div>
        <div><div class="label">Pussi vs. yö</div><div class="value" id="bagOK">–</div></div>
        <div><div class="label">Pinon paino</div><div class="value" id="wtotal">–</div></div>
      </div>

      <div style="margin-top:10px"><div class="section-title">Suositus</div><div id="advice">Lisää alustoja ja anna yölämpötila.</div></div>
      <div style="margin-top:10px"><div class="section-title">Miksi näin?</div><div id="explain" class="muted">R_req nousee kylmään mentäessä (~2.0 @ +10 °C, ~3.2 @ 0 °C, ~4.4 @ −10 °C, ~5.6 @ −20 °C). Humus/sammal ~+0.3 R, tiivis lumi ~+0.5 R, lattiasuoja +0.1 R. Pino OK, jos R_pino ≥ R_req.</div></div>
    </section>
  </main>

  <script>
    const $=(id)=>document.getElementById(id);
    const toNum=(v)=>{if(v===undefined||v===null) return NaN; const s=String(v).trim().replace(/\s+/g,'').replace('−','-').replace(',','.'); if(s==='')return NaN; const n=parseFloat(s); return Number.isFinite(n)?n:NaN};

    const presets={air2:{name:'Ilmapatja kevyt',R:2.0,w:400},air35:{name:'Ilmapatja 3‑kerros',R:3.5,w:500},air55:{name:'Talvi‑ilmapatja',R:5.5,w:700},foam1:{name:'Solumuovi ohut',R:1.0,w:200},foam2:{name:'Solumuovi paksu',R:2.0,w:400}};
    let stack=[]; // {name,R,w}

    function renderStack(){ const tb=$('stackTable').querySelector('tbody'); tb.innerHTML=''; stack.forEach((it,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${it.name}</td><td>${it.R.toFixed(1)}</td><td>${Number.isFinite(it.w)?it.w:'–'}</td><td><button class="del" data-i="${i}">Poista</button></td>`; tb.appendChild(tr); }); tb.querySelectorAll('button.del').forEach(btn=>btn.addEventListener('click',(e)=>{ const i=parseInt(e.currentTarget.getAttribute('data-i')); stack.splice(i,1); renderStack(); compute(); })); }

    const rBonusGround=(g)=>({mineral:0.0,duff:0.3,snow:0.5}[g]||0)
    const rBonusFloor=(f)=>({none:0.0,sheet:0.1}[f]||0)
    const rReqPad=(Tn,sleeper,ground,floor)=>{ if(!Number.isFinite(Tn)) return NaN; const base=0.8 + 0.12*(20 - Tn); const adj={cold:+0.3,normal:0.0,warm:-0.3}[sleeper]||0; const bonus=rBonusGround(ground)+rBonusFloor(floor); return Math.max(0, base + adj - bonus); }

    function totals(){ const Rtot=stack.reduce((s,it)=>s+(Number.isFinite(it.R)?it.R:0),0); const Wtot=stack.reduce((s,it)=>s+(Number.isFinite(it.w)?it.w:0),0); return {Rtot,Wtot}; }

    function compute(){
      const {Rtot,Wtot}=totals(); $('rtot').textContent=Rtot?Rtot.toFixed(1):'–'; $('wtotal').textContent=(Number.isFinite(Wtot)&&Wtot>0)?`${Wtot} g`:'–'; const Tfloor=20-7.5*Rtot; $('tfloor').textContent=Rtot?`${Tfloor.toFixed(1)} °C`:'–';

      const Tn=toNum($('tempNight').value); const sleeper=$('sleeper').value; const ground=$('ground').value; const floor=$('floor').value; const bag=toNum($('bagComfort').value);
      if(!Number.isFinite(Tn)){ $('rneed').textContent='–'; $('rgap').textContent='–'; $('bagOK').textContent='–'; $('advice').textContent='Anna yölämpötila (esim. 2 tai −10) ja lisää alustoja.'; return }

      const Rneed=rReqPad(Tn,sleeper,ground,floor); $('rneed').textContent=Rneed.toFixed(1);
      const gap=(Rtot - Rneed); $('rgap').innerHTML = gap>=0 ? `<span class="ok">+${gap.toFixed(1)} R</span>` : `<span class="bad">${gap.toFixed(1)} R</span>`;

      let bagTxt='–'; if(Number.isFinite(bag)){ bagTxt=(Tn>=bag)?'OK':`Vajaus ${(bag-Tn).toFixed(1)} °C` }
      $('bagOK').innerHTML=(bagTxt==='OK')?`<span class="ok">OK</span>`:(bagTxt==='–'?'–':`<span class="bad">${bagTxt}</span>`);

      const advice=[]; if(gap<0){ const need=-gap; if(need<=0.6) advice.push('Lisää ohut solumuovi (R≈0.5–1.0).'); else if(need<=1.6) advice.push('Lisää paksumpi solumuovi tai lämpimämpi ilmapatja (+R≈1–2).'); else advice.push('Talvikombo: lämmin ilmapatja + solumuovi (R≥5–6).'); } else { advice.push('R riittää maasta – säädä pussi/takki tuulen ja kosteuden mukaan.'); }
      if(ground==='duff') advice.push('Humus/sammal eristää hieman – hyvä valinta kylmälle maalle.'); if(ground==='snow') advice.push('Tiivis lumialusta eristää – tasaa alusta ja käytä solumuovia puhkaisusuojaksi.'); if(Number.isFinite(bag) && Tn<bag) advice.push('Lisälämpö yläkautta: puffy pussin sisään / lisälakana.');
      $('advice').innerHTML=advice.map(x=>`<span class="pill">${x}</span>`).join(' ');
    }

    function autoFill(){
      const Tn=toNum($('tempNight').value); if(!Number.isFinite(Tn)){ alert('Anna yölämpötila (esim. 2 tai −10)'); return }
      const sleeper=$('sleeper').value; const ground=$('ground').value; const floor=$('floor').value;
      let Rneed=rReqPad(Tn,sleeper,ground,floor);
      let {Rtot}=totals();
      // Ehdokkaat lisäykseen ja niiden paino/R
      const candidates=[presets.foam1, presets.foam2]; // kevyt ja paksu solumuovi
      // paino-optimoitu greedy (kaikilla sama paino/R → toimii silti, mutta rakenne joustava)
      let guard=12;
      while(Rtot < Rneed && guard-->0){
        const delta=Rneed-Rtot;
        // valitse kevyin tapa kasvattaa R:ää riittävästi tässä stepissä
        // lasketaan kustannus (paino / saavutettu R-osa)
        let pick=candidates[0];
        let bestRatio=Infinity;
        for(const c of candidates){
          const gain=Math.min(c.R, delta); // käytännön hyöty tällä stepillä
          const ratio=c.w / gain; // g per saavutettu R-osa
          if(ratio < bestRatio){ bestRatio=ratio; pick=c; }
        }
        stack.push({...pick});
        Rtot+=pick.R;
      }
      renderStack(); compute();
    }

    function removeLast(){ if(stack.length===0){ alert('Pino on tyhjä.'); return } stack.pop(); renderStack(); compute(); }

    // UI
    $('addPreset').addEventListener('click',()=>{ const key=$('presetSelect').value; let it=key&&presets[key]?{...presets[key]}:{name:'Mukautettu alusta',R:NaN,w:NaN}; const r=toNum($('presetR').value); const w=toNum($('presetW').value); if(Number.isFinite(r)) it.R=r; if(Number.isFinite(w)) it.w=Math.round(w); if(!Number.isFinite(it.R)){ $('err').textContent='Anna R‑arvo (esim. 2,5) tai valitse tyyppi.'; $('err').style.display='block'; return } $('err').style.display='none'; stack.push(it); $('presetSelect').value=''; $('presetR').value=''; $('presetW').value=''; renderStack(); })
    $('removeLast').addEventListener('click', removeLast);
    $('clearList').addEventListener('click',()=>{ stack=[]; renderStack(); })

    $('autoFill').addEventListener('click', autoFill);

    // Presetit
    $('preset1').addEventListener('click',()=>{ stack=[{...presets.air2}]; $('tempNight').value='8'; $('ground').value='mineral'; $('floor').value='none'; $('sleeper').value='normal'; $('bagComfort').value='5'; renderStack(); })
    $('preset2').addEventListener('click',()=>{ stack=[{...presets.air35},{...presets.foam1}]; $('tempNight').value='2'; $('ground').value='duff'; $('floor').value='sheet'; $('sleeper').value='normal'; $('bagComfort').value='0'; renderStack(); })
    $('preset3').addEventListener('click',()=>{ stack=[{...presets.air55},{...presets.foam2}]; $('tempNight').value='-15'; $('ground').value='snow'; $('floor').value='sheet'; $('sleeper').value='cold'; $('bagComfort').value='-10'; renderStack(); })

    $('calc').addEventListener('click', compute);
    renderStack();
  </script>
  <script src="retkilab-header.js"></script>
</body>
</html>